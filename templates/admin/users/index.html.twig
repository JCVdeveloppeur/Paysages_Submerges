{% extends 'admin/layout.html.twig' %}

{% block page_title %}Gestion des utilisateurs{% endblock %}
{% block page_heading %}<i class="bi bi-people"></i> Gestion des utilisateurs{% endblock %}

{% block content %}
<div class="admin-surface">

  <div class="admin-surface__head">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <h3 class="mb-0">Utilisateurs</h3>

      <span class="badge text-bg-primary">
        {{ users.getTotalItemCount }} total
      </span>
    </div>

    <a href="{{ path('admin_dashboard') }}" class="btn btn-outline-light">
      <i class="bi bi-speedometer2 me-2"></i> Tableau de bord
    </a>
  </div>

  <div class="admin-surface__body">

    {# --- Formulaire de filtre --- #}
    <form method="get" action="{{ path('admin_users') }}" class="row g-3 mb-3 align-items-end admin-filters">
      <div class="col-md-4">
        <label class="form-label mb-1">Pseudo</label>
        <input
          type="text"
          name="pseudo"
          value="{{ app.request.get('pseudo') }}"
          class="form-control admin-input-glass"
          placeholder="Rechercher par pseudo..."
        >
      </div>

      <div class="col-md-3">
        <label class="form-label mb-1">Rôle</label>
        <select name="role" class="form-select admin-select-glass">
          <option value="">-- Tous les rôles --</option>
          <option value="ROLE_USER"  {{ app.request.get('role') == 'ROLE_USER'  ? 'selected' }}>Utilisateur</option>
          <option value="ROLE_ADMIN" {{ app.request.get('role') == 'ROLE_ADMIN' ? 'selected' }}>Administrateur</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label mb-1">Affichage</label>
        <select name="limit" class="form-select admin-select-glass" onchange="this.form.submit()">
          {% for value in [5, 10, 20, 50, 100] %}
            <option value="{{ value }}" {{ limit == value ? 'selected' : '' }}>
              {{ value }} / page
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2 d-flex gap-2">
        <button type="submit" class="btn-filtrer w-100">
          <i class="bi bi-search me-1"></i> Filtrer
        </button>
        <a href="{{ path('admin_users') }}" class="btn-reinitialiser w-100">
          <i class="bi bi-x-circle me-1"></i> Reset
        </a>
      </div>
    </form>

    {# --- Résumé --- #}
    <div class="admin-hint mb-3">
      Affichage de <strong>{{ users|length }}</strong> utilisateur{{ users|length > 1 ? 's' }} sur
      <strong>{{ users.getTotalItemCount }}</strong>.
    </div>

    {# --- Tableau --- #}
    {% if users|length == 0 %}
      <div class="alert alert-warning mb-0">
        Aucun utilisateur ne correspond à ce filtre.
      </div>
    {% else %}
      <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle admin-table-glass">
          <thead>
            <tr>
              <th>ID</th>
              <th>Pseudo</th>
              <th>Email</th>
              <th>Rôles</th>
              <th>Inscription</th>
              <th>Dernière connexion</th>
              <th>Statut</th>
              <th class="text-end">Action</th>
            </tr>
          </thead>

          <tbody>
            {% for user in users %}
              <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.pseudo ?? '(non renseigné)' }}</td>
                <td>{{ user.email }}</td>

                <td class="text-nowrap">
                  {% for role in user.roles %}
                    {% if role == 'ROLE_ADMIN' %}
                      <span class="badge badge-admin-glass">
                        <i class="bi bi-shield-lock-fill me-1"></i> Admin
                      </span>
                    {% elseif role == 'ROLE_USER' %}
                      <span class="badge badge-user-glass">
                        <i class="bi bi-person-fill me-1"></i> Utilisateur
                      </span>
                    {% else %}
                      <span class="badge text-bg-secondary">{{ role }}</span>
                    {% endif %}
                  {% endfor %}
                </td>

                <td>{{ user.dateInscription ? user.dateInscription|date('d/m/Y') : 'N/A' }}</td>
                <td>{{ user.lastLogin ? user.lastLogin|date('d/m/Y H:i') : 'Jamais' }}</td>

                <td class="text-nowrap">
                  {% if user.lastLogin and user.lastLogin > sevenDaysAgo %}
                    <span class="badge-actif">
                      <i class="bi bi-circle-fill me-1"></i> Actif
                    </span>
                  {% else %}
                    <span class="badge-inactif">
                      <i class="bi bi-dash-circle-fill me-1"></i> Inactif
                    </span>
                  {% endif %}
                </td>
                <td class="text-end">
                  {% if app.user and app.user.id == user.id %}
                    <span class="text-muted small">—</span>
                  {% else %}
                    {% include 'admin/_actions_row.html.twig' with {
                      edit_path: null,
                      delete_path: path('admin_user_delete', { id: user.id }),
                      csrf_token_id: 'delete-user-' ~ user.id,

                      delete_kind: 'user',
                      delete_kicker: "Suppression d'utilisateur",
                      delete_title: "Supprimer cet utilisateur ?",
                      delete_subtitle: "Cette action est irréversible.",
                      delete_body: "Vous êtes sûr de vouloir supprimer : <strong>" ~ (user.pseudo|default(user.email|default('cet utilisateur')))|e('html_attr') ~ "</strong> ?",

                      confirm_label: "Oui, supprimer",
                      confirm_variant: "danger"
                    } %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-center mt-3 admin-pagination-glass">
        {{ knp_pagination_render(users) }}
      </div>
    {% endif %}

  </div>
</div>
{% endblock %}







