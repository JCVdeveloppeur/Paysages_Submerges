{% extends 'base.html.twig' %}

{% block title %}Maladies des poissons{% endblock %}

{% block body %}
<div class="container my-5 maladie-index">
    <h1 class="page-title">
    <span class="page-icon">üíä</span>
    Encyclop√©die des maladies des poissons d'eau douce
    </h1>

    <p class="page-subtitle">
    Un aper√ßu des principales maladies : gravit√©, contagion, agents pathog√®nes et sympt√¥mes cl√©s.
    </p>

        {# Barre outils : recherche + select (m√™me ligne) #}
        <div class="row justify-content-center mb-3">
        <div class="col-12 col-lg-10">
            <div class="d-flex flex-column flex-md-row align-items-stretch align-items-md-center gap-2">

            {# --- Recherche (GET) --- #}
            <div class="flex-grow-1 bloc-recherche-espece">
                {{ form_start(form, {'method': 'GET', 'attr': {'id': 'recherche-maladie-form', 'class': 'w-100'}}) }}

                {# conserver limit quand on cherche #}
                <input type="hidden" name="limit" value="{{ limit }}">

                <div class="position-relative">
                    {{ form_widget(form.nom, {
                    'attr': {
                        'class': 'form-control pe-5',
                        'placeholder': 'ü¶† Rechercher une maladie‚Ä¶'
                    }
                    }) }}

                    <button type="button"
                            class="btn-clear-search"
                            aria-label="Effacer la recherche"
                            title="Effacer la recherche">

                    <svg class="icon-carnet-x"
                        viewBox="0 0 24 24"
                        aria-hidden="true">

                        <!-- cercle carnet (UNIQUEMENT contour) -->
                        <path
                        fill="none"
                        d="M12 2.8
                            C7.1 2.8 3.1 7 3.1 12
                            c0 5.2 4 9.2 8.9 9.2
                            c5 0 8.9-4 8.9-9.2
                            c0-5-3.9-9.2-8.9-9.2z" />

                        <!-- croix -->
                        <path d="M8.2 8.4 L15.6 15.7" />
                        <path d="M15.4 8.3 L8.3 15.6" />

                    </svg>
                    </button>



                </div>

                {{ form_end(form) }}
            </div>

            {# --- Select (GET) --- #}
            <form method="get"
                    class="d-flex align-items-center justify-content-md-end gap-2 small text-muted flex-shrink-0">

                {# conserver la recherche #}
                <input type="hidden" name="nom" value="{{ app.request.get('nom') }}">

                {# reset page quand on change le limit #}
                <input type="hidden" name="page" value="1">

                <label for="limit" class="mb-0">Afficher :</label>

                <select name="limit" id="limit"
                        class="form-select form-select-sm"
                        style="width: 80px"
                        onchange="this.form.submit()">
                <option value="6"  {{ limit == 6 ? 'selected' }}>6</option>
                <option value="9"  {{ limit == 9 ? 'selected' }}>9</option>
                <option value="12" {{ limit == 12 ? 'selected' }}>12</option>
                </select>
            </form>

            </div>
        </div>
        </div>

    {# L√©gende des niveaux de gravit√© #}
    <div class="maladie-legend mb-4 text-center">
        <span class="maladie-legend__item maladie-legend__item--faible">
            <span class="maladie-legend__dot"></span> Gravit√© faible
        </span>
        <span class="maladie-legend__item maladie-legend__item--moyenne">
            <span class="maladie-legend__dot"></span> Gravit√© moyenne
        </span>
        <span class="maladie-legend__item maladie-legend__item--elevee">
            <span class="maladie-legend__dot"></span> Gravit√© √©lev√©e
        </span>
    </div>

    {% if maladie_poissons|length == 0 %}
    <div class="alert alert-info text-center mb-4">
        Aucune maladie enregistr√©e pour le moment.
    </div>
{% else %}

    <div class="paginated-content">
        <div id="maladie-results" class="row row-cols-1 row-cols-md-3 g-4 results-animate">
            {% for maladie in maladie_poissons %}
                <div class="col results-item">

                    {# D√©tection du niveau de gravit√© #}
                    {% set graviteValue = maladie.gravite ? maladie.gravite|lower : '' %}
                    {% set graviteLevel =
                        graviteValue == 'faible' ? 'faible' :
                        (graviteValue starts with 'moyen' ? 'moyenne' :
                        (graviteValue starts with '√©lev' or graviteValue starts with 'eleve' ? 'elevee' : ''))
                    %}
                    {% set graviteClass = graviteLevel ? 'gravite--' ~ graviteLevel : '' %}
                    {% set cardGraviteClass = graviteLevel ? 'card-maladie--' ~ graviteLevel : '' %}

                    <div class="card h-100 shadow-sm card-carnet card-carnet--compact card-maladie {{ cardGraviteClass }}">
                        {# IMAGE #}
                        {% if maladie.image %}
                            <img src="{{ asset('uploads/maladies/' ~ maladie.image) }}"
                                 class="card-img-top image-carte"
                                 alt="{{ maladie.nom }}">
                        {% else %}
                            <div class="image-carte image-carte--placeholder">
                                <span>ü©∫</span>
                            </div>
                        {% endif %}

                        <div class="card-body">
                            <h5 class="card-title">
                                <span class="me-1">üíä</span>{{ maladie.nom }}
                            </h5>

                            <p class="card-text text-muted">
                                {% if maladie.agentPathogene %}
                                    <em>Agent : {{ maladie.agentPathogene }}</em><br>
                                {% endif %}

                                <span class="d-inline-flex flex-wrap gap-2 mt-2">
                                    {% if maladie.gravite %}
                                        <span class="badge-gravite {{ graviteClass }}">{{ maladie.gravite }}</span>
                                    {% endif %}

                                    <span class="badge-contagion badge-contagion--mini {{ maladie.contagieuse ? 'badge-contagion--oui' : 'badge-contagion--non' }}">
                                        {{ maladie.contagieuse ? 'Contagieuse' : 'Non contagieuse' }}
                                    </span>
                                </span>
                            </p>

                            <p class="card-text small text-muted mb-0">
                                {% if maladie.symptomes %}
                                    {% set desc = maladie.symptomes|striptags %}
                                    {{ desc|length > 120 ? desc|slice(0, 120) ~ '‚Ä¶' : desc }}
                                {% else %}
                                    <span class="text-muted">Sympt√¥mes √† d√©crire.</span>
                                {% endif %}
                            </p>
                        </div>

                        <div class="card-footer d-flex justify-content-end">
                            <a href="{{ path('app_maladie_poisson_show', { id: maladie.id }) }}" class="btn btn-espece btn-sm">
                                üîç Voir la fiche
                            </a>
                        </div>

                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="d-flex justify-content-center mt-4">
            {{ knp_pagination_render(maladie_poissons) }}
        </div>
    </div>

{% endif %}

</div>
{% endblock %}









