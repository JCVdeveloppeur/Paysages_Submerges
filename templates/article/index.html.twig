{% extends 'base.html.twig' %}

{% block title %}Articles - Paysages Submerg√©s{% endblock %}

{% block body %}
<section class="section-articles py-6 bg-light">
    <div class="container">
        <h1 class="mb-2 text-center">Tous nos articles</h1>
        <p class="lead text-center mb-5">Laissez-vous √©merveiller par la diversit√© sous-marine.</p>

        {% if searchTerm is defined and searchTerm %}
            <div class="alert alert-info text-center">
                R√©sultats pour : <strong>{{ searchTerm }}</strong> - {{ articles|length }} article{{ articles|length > 1 ? 's' : '' }} trouv√©{{ articles|length > 1 ? 's' : '' }}.
            </div>
        {% endif %}

        <div class="row">
            <!-- Colonne principale -->
            <div class="col-lg-9">
                {% if articles is not empty %}
                    <div class="row" id="articles-list">
                        {% for article in articles %}
                            <div class="col-md-6 col-xl-4 mb-4">
                                <div class="card h-100 shadow-sm">
                                    {% if article.image %}
                                        <img src="{{ asset('uploads/articles/' ~ article.image) }}" class="card-img-top" alt="{{ article.titre }}">
                                    {% else %}
                                        {% set dossierCategorie = {
                                            'Biotope Am√©rique du sud': 'amerique-sud',
                                            'Biotope asiatique': 'asiatique',
                                            'Biotope africain': 'africain',
                                            'Biotope australien': 'australien',
                                            'Autre': 'autre'
                                        }[article.categorie] ?? 'autre' %}
                                        {% set randomImage = random([1, 2, 3]) %}
                                        <img src="{{ asset('build/images/defaults/articles/' ~ dossierCategorie ~ '/' ~ randomImage ~ '.jpg') }}" class="card-img-top" alt="Image par d√©faut pour {{ article.categorie }}">
                                    {% endif %}

                                    <div class="card-body">
                                        <h5 class="card-title">{{ article.titre }}</h5>

                                        {% set badgeClass = {
                                            'Biotope Am√©rique du sud': 'badge-amerique-sud',
                                            'Biotope asiatique': 'badge-asiatique',
                                            'Biotope africain': 'badge-africain',
                                            'Biotope australien': 'badge-australien',
                                            'Autre': 'badge-autre'
                                        }[article.categorie] ?? 'badge-autre' %}

                                        <span class="badge {{ badgeClass }}">
                                            {{ {
                                                'Biotope Am√©rique du sud': 'üå±',
                                                'Biotope asiatique': 'üåä',
                                                'Biotope africain': 'üèúÔ∏è',
                                                'Biotope australien': 'ü™∏',
                                                'Autre': 'üåç'
                                            }[article.categorie] ?? 'üåç' }}
                                            {{ article.categorie }}
                                        </span>

                                        <p class="card-text">
                                            {{ article.contenu|length > 100 ? article.contenu|slice(0, 100) ~ '...' : article.contenu }}
                                        </p>

                                        <div class="d-flex flex-column gap-2 mt-3">
                                            <a href="{{ path('app_article_show', {'id': article.id}) }}" class="btn btn-lire-suite">Lire la suite</a>

                                            {% if app.user %}
                                                {% if is_granted('ROLE_ADMIN') %}
                                                    <a href="{{ path('article_edit', {'id': article.id}) }}" class="btn-admin-modifier">
                                                        <i class="bi bi-pencil-square"></i> Modifier
                                                    </a>
                                                    <button
                                                        type="button"
                                                        class="btn-admin-supprimer"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#deleteModal"
                                                        data-action="{{ path('article_delete', {'id': article.id}) }}"
                                                        data-token="{{ csrf_token('delete' ~ article.id) }}"
                                                        title="Supprimer">
                                                        <i class="bi bi-trash3"></i> Supprimer
                                                    </button>
                                                {% elseif article.user == app.user and not article.estApprouve %}
                                                    <a href="{{ path('article_edit', {'id': article.id}) }}" class="btn-admin-modifier">
                                                        <i class="bi bi-pencil-square"></i> Modifier
                                                    </a>
                                                    <button
                                                        type="button"
                                                        class="btn-admin-supprimer"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#deleteModal"
                                                        data-action="{{ path('article_delete', {'id': article.id}) }}"
                                                        data-token="{{ csrf_token('delete' ~ article.id) }}"
                                                        title="Supprimer">
                                                        <i class="bi bi-trash3"></i> Supprimer
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="card-footer text-muted">
                                        Publi√© {{ article.createdAt|human_date }}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-warning text-center">
                        {% if searchTerm is defined and searchTerm %}
                            Aucun article ne correspond √† votre recherche ¬´ {{ searchTerm }} ¬ª.
                        {% else %}
                            Aucun article disponible pour le moment.
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Colonne droite -->
            <div class="col-lg-3">
                <div class="sticky-top" style="top: 100px;">
                    <div class="mb-4 p-3 bg-white rounded shadow-sm">
                        <h5 class="mb-3">üîî Espace publicitaire</h5>
                        <p>Votre publicit√© ici ? Contactez-nous.</p>
                    </div>

                    <div class="mb-4 p-3 bg-white rounded shadow-sm">
                        <h5 class="mb-3">üåø Concours Franc√ßais d'Aquascaping</h5>
                        <p>D√©couvrez le concours d'aquascaping et de paysages aquatiques, des ≈ìuvres d'art vivantes !</p>
                        <a href="https://capa-aquascaping.fr/" class="btn btn-concours" target="_blank" rel="noopener noreferrer">Voir les concours üåç</a>
                    </div>
                    <div class="mb-4 p-3 bg-white rounded shadow-sm">
                        <h5 class="mb-3">üåø Concours internationaux d'Aquascaping</h5>
                        <p>D√©couvrez le concours international d'aquascaping, des ≈ìuvres d'art vivantes !</p>
                        <a href="https://showcase.aquatic-gardeners.org/" class="btn btn-concours" target="_blank" rel="noopener noreferrer">Voir les concours üåç</a>
                    </div>

                    {% if lastArticles is defined and lastArticles|length > 0 %}
                        <div class="mb-4 p-3 bg-white rounded shadow-sm">
                            <h5 class="mb-3">üì∞ Derniers articles publi√©s</h5>
                            {% set defaultImages = {
                                'Biotope Am√©rique du sud': ['sud1.jpg', 'sud2.jpg', 'sud3.jpg'],
                                'Biotope asiatique': ['asie1.jpg', 'asie2.jpg', 'asie3.jpg'],
                                'Biotope africain': ['afrique1.jpg', 'afrique2.jpg'],
                                'Biotope australien': ['australie1.jpg', 'australie2.jpg'],
                                'Autre': ['autre1.jpg', 'autre2.jpg']
                            } %}

                            {% for last in lastArticles|slice(0, 3) %}
                                {% set badgeClass = {
                                    'Biotope Am√©rique du sud': 'badge-amerique-sud',
                                    'Biotope asiatique': 'badge-asiatique',
                                    'Biotope africain': 'badge-africain',
                                    'Biotope australien': 'badge-australien',
                                    'Autre': 'badge-autre'
                                }[last.categorie] ?? 'badge-autre' %}

                                {% set icon = {
                                    'Biotope Am√©rique du sud': 'üå±',
                                    'Biotope asiatique': 'üåä',
                                    'Biotope africain': 'üèúÔ∏è',
                                    'Biotope australien': 'ü™∏',
                                    'Autre': 'üåç'
                                }[last.categorie] ?? 'üåç' %}

                                {% set defaultImage = defaultImages[last.categorie]|default(['default.jpg'])|random_element %}

                                <a href="{{ path('app_article_show', {'id': last.id}) }}" class="text-decoration-none text-dark">
                                    <div class="card mb-3">
                                        {% if last.image %}
                                            <img src="{{ asset('uploads/articles/' ~ last.image) }}" class="card-img-top" alt="{{ last.titre }}">
                                        {% else %}
                                            <img src="{{ asset('build/images/defaults/' ~ defaultImage) }}" class="card-img-top" alt="Image par d√©faut">
                                        {% endif %}
                                        <div class="card-body p-2">
                                            <h6 class="card-title mb-1" style="font-size: 0.95rem;">
                                                {{ last.titre|length > 40 ? last.titre|slice(0, 40) ~ '‚Ä¶' : last.titre }}
                                            </h6>
                                            <span class="badge {{ badgeClass }} mb-1 d-inline-block">
                                                {{ icon }} {{ last.categorie }}
                                            </span>
                                            <small class="text-muted d-block">{{ last.createdAt|human_date }}</small>
                                        </div>
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modale Bootstrap de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-sm border-0 rounded-3">
      <div class="modal-header bg-light border-0">
        <h5 class="modal-title text-dark" id="deleteModalLabel">
          <i class="bi bi-exclamation-circle-fill text-warning me-2 fs-4"></i>
          Attention !
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body text-center">
        <p class="mb-0">
          √ätes-vous s√ªr de vouloir supprimer cet article ?<br>
          <small class="text-muted">Cette action sera irr√©versible.</small>
        </p>
      </div>
      <div class="modal-footer border-0 d-flex justify-content-center gap-3">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
          Annuler
        </button>
        <form id="deleteForm" method="post" class="d-inline">
        <input type="hidden" name="_token" id="deleteFormToken">
        <button type="submit" class="btn btn-confirm-suppression btn-sm px-4 rounded-pill">
        <i class="bi bi-trash3 me-1"></i> Oui, supprimer
        </button>

        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        const deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const action = button.getAttribute('data-action');
            const token = button.getAttribute('data-token');

            const form = deleteModal.querySelector('#deleteForm');
            const tokenInput = deleteModal.querySelector('#deleteFormToken');

            form.setAttribute('action', action);
            tokenInput.value = token;
        });
    </script>
    
    <script>
        // Lors de l‚Äôouverture de la modale
        const deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const action = button.getAttribute('data-action');
            const token = button.getAttribute('data-token');

            const form = deleteModal.querySelector('#deleteForm');
            const tokenInput = deleteModal.querySelector('#deleteFormToken');

            form.setAttribute('action', action);
            tokenInput.value = token;

            // Ajoute une classe sp√©ciale au backdrop pour appliquer le flou
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.classList.add('blur-backdrop');
                }
            }, 10);
        });
    </script>
{% endblock %}







