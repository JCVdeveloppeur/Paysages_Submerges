{% extends 'base.html.twig' %}

{% block title %}Articles - Paysages Submerg√©s{% endblock %}

{% block body %}
<section class="section-articles py-6 bg-light">
    <div class="container">
        <h1 class="mb-2 text-center"> üìñ Tous les articles</h1>
        <p class="lead text-center mb-5"> Parcourez tous les articles et laissez-vous inspirer par la diversit√© sous-marine.</p>

        {# Filtre biotope actif (quand on vient de /articles/biotope/...) #}
        {% if currentBiotope is defined and currentBiotope %}
    <div class="d-flex justify-content-center align-items-center gap-2 mb-4 flex-wrap bio-context bio-{{ currentBiotope }}">
        <span class="badge badge-{{ currentBiotope }}">
        üåç {{ currentBioLabel ?? currentBiotope }}
        </span>

        {% if returnUrl is defined and returnUrl %}
        <a class="btn-bio-reset" href="{{ returnUrl }}">
            ‚Üê Retour √† l'article
        </a>
        {% endif %}
    </div>
    {% endif %}


        {% if searchTerm is defined and searchTerm %}
        <div class="alert alert-info text-center">
            R√©sultats pour : <strong>{{ searchTerm }}</strong> -
            {{ articles.getTotalItemCount }} article{{ articles.getTotalItemCount > 1 ? 's' : '' }}
            trouv√©{{ articles.getTotalItemCount > 1 ? 's' : '' }}.
        </div>
        {% endif %}

        <div class="row">
            <!-- Colonne principale -->
            <div class="col-lg-9">
                {% if articles|length > 0 %}
                <form method="get" class="d-flex justify-content-end mb-3 gap-2">
                {# Conserver les filtres existants #}
                {% if searchTerm %}
                    <input type="hidden" name="q" value="{{ searchTerm }}">
                {% endif %}

                {% if app.request.query.get('auteur') %}
                    <input type="hidden" name="auteur" value="{{ app.request.query.get('auteur') }}">
                {% endif %}

                {% if returnUrl is defined and returnUrl %}
                <input type="hidden" name="return" value="{{ returnUrl }}">
                {% endif %}

                {# Reset page quand on change le nombre #}
                <input type="hidden" name="page" value="1">

                <label for="limit" class="mb-0">Afficher :</label>

                <select
                    name="limit"
                    class="form-select form-select-sm"
                    style="width:auto"
                    onchange="this.form.submit()"
                >
                    <option value="6"  {{ limit == 6  ? 'selected' }}>6</option>
                    <option value="9"  {{ limit == 9  ? 'selected' }}>9</option>
                    <option value="12" {{ limit == 12 ? 'selected' }}>12</option>
                </select>
            </form>

                <div class="paginated-content">
                    <div class="row" id="articles-list">
                        {% for article in articles %}
                        {# slug pour la couleur / accent #}
                        {% set badgeSlug = {
                        'Biotope Am√©rique du sud': 'amerique-sud',
                        'Biotope Am√©rique centrale': 'amerique-centrale',
                        'Biotope asiatique': 'asiatique',
                        'Biotope africain': 'africain',
                        'Biotope australien': 'australien',
                        'Biotope europ√©en': 'europeen',
                        'Biotope eaux saum√¢tres': 'eaux-saumatres',
                        'Biotope mangroves': 'mangroves',
                        'Autre': 'autre'
                        }[article.categorie] ?? 'autre' %}

                        {% set badgeClass = 'badge-' ~ badgeSlug %}

                            <div class="col-md-6 col-xl-4 mb-4">
                            <div class="card h-100 shadow-sm
                                        card-carnet card-carnet--compact
                                        card-article card-accent-badge-{{ badgeSlug }}">
                                    {% if article.image %}
                                        <img src="{{ asset('uploads/articles/' ~ article.image) }}"
                                            class="card-img-top image-carte"
                                            alt="{{ article.titre }}">
                                    {% else %}
                                        {% set dossierCategorie = badgeSlug %}
                                        {% set randomImage = random([1, 2, 3]) %}
                                        <img src="{{ asset('build/images/defaults/articles/' ~ dossierCategorie ~ '/' ~ randomImage ~ '.jpg') }}"
                                            class="card-img-top image-carte"
                                            alt="Image par d√©faut pour {{ article.categorie }}">
                                    {% endif %}

                                    <div class="card-body">
                                        <h5 class="card-title">{{ article.titre }}</h5>

                                        <span class="badge {{ badgeClass }}">
                                        {{ {
                                            'Biotope Am√©rique du sud': 'üåø',
                                            'Biotope Am√©rique centrale': 'üå¥',
                                            'Biotope asiatique': 'üéã',
                                            'Biotope africain': 'üåæ',
                                            'Biotope australien': 'üå∫',
                                            'Biotope europ√©en': 'üçÉ',
                                            'Biotope eaux saum√¢tres': 'ü´ß',
                                            'Biotope mangroves': 'üå±',
                                            'Autre': 'üåç'
                                        }[article.categorie] ?? 'üåç' }}
                                        {{ article.categorie }}
                                        </span>

                                        <p class="card-text">
                                            {{ article.contenu|length > 100 ? article.contenu|slice(0, 100) ~ '...' : article.contenu }}
                                        </p>

                                        <div class="d-flex flex-column gap-2 mt-3">
                                        {% set returnFromQuery = app.request.query.get('return') %}
                                            <a class="btn btn-espece btn-sm"
                                            href="{{ path('app_article_show', {
                                                id: article.id,
                                                biotope: currentBiotope|default(null),
                                                q: searchTerm|default(''),
                                                page: articles.currentPageNumber,
                                                limit: limit,
                                                return: returnUrl|default(null),
                                                return_title: returnTitle|default(null)
                                                }) }}">
                                             Lire l'article
                                            </a>

                                            {% if app.user %}
                                                {% if is_granted('ROLE_ADMIN') or (article.user == app.user and not article.estApprouve) %}
                                                    <a href="{{ path('article_edit', {'id': article.id}) }}" class="btn-admin-modifier">
                                                        <i class="bi bi-pencil-square"></i> Modifier
                                                    </a>

                                                    <button
                                                        type="button"
                                                        class="btn-admin-supprimer"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#deleteModal"
                                                        data-action="{{ path('article_delete', {'id': article.id}) }}"
                                                        data-token="{{ csrf_token('delete' ~ article.id) }}"
                                                        title="Supprimer">
                                                        <i class="bi bi-trash3"></i> Supprimer
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="card-footer text-muted">
                                        Publi√© {{ article.createdAt|human_date }}
                                    </div>

                                </div>
                            </div>

                        {% endfor %}

                    </div>
                    {# Pagination  #}

                    <div class="d-flex justify-content-center mt-4">
                    {% if returnUrl is defined and returnUrl %}
                    
                    {% endif %}
                    {{ knp_pagination_render(articles, null, {}, { query: app.request.query.all }) }}

                    </div>

                </div>
                {% else %}
                    <div class="alert alert-warning text-center">
                        {% if searchTerm is defined and searchTerm %}
                            Aucun article ne correspond √† votre recherche ¬´ {{ searchTerm }} ¬ª.
                        {% else %}
                            Aucun article disponible pour le moment.
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Colonne droite -->
            <div class="col-lg-3 sidebar">
                <div class="sticky-top" style="top: 100px;">
                    <div class="mb-4 p-3 bg-white rounded shadow-sm sidebar-card">
                        <h5 class="mb-3"> Espace publicitaire</h5>
                        <p>Votre publicit√© ici ? Contactez-nous.</p>
                    </div>

                    <div class="mb-4 p-3 bg-white rounded shadow-sm concours-card sidebar-card">
                        <h5 class="mb-3 d-flex align-items-center gap-2">
                            Concours d'Aquascaping
                        </h5>

                        <ul class="contest-list list-unstyled m-0">
                            <li class="contest-item">
                            <div class="contest-icon" aria-hidden="true">üá´üá∑</div>
                            <div class="contest-content">
                                <h6 class="contest-title m-0">Concours Fran√ßais d'Aquascaping</h6>
                                <p class="contest-desc mb-2">Trouver l'inspiration.</p>
                                <a href="https://capa-aquascaping.fr/"
                                class="btn btn-concours btn-sm"
                                target="_blank" rel="noopener noreferrer"
                                aria-label="Ouvrir le Concours Fran√ßais d'Aquascaping (nouvel onglet)">
                                Voir les concours
                                </a>
                            </div>
                            </li>

                            <li class="contest-item">
                            <div class="contest-icon" aria-hidden="true">üåê</div>
                            <div class="contest-content">
                                <h6 class="contest-title m-0">Concours international d'Aquascaping</h6>
                                <p class="contest-desc mb-2">Des oeuvres d'Art vivantes .</p>
                                <a href="https://showcase.aquatic-gardeners.org/"
                                class="btn btn-concours btn-sm"
                                target="_blank" rel="noopener noreferrer"
                                aria-label="Ouvrir les concours internationaux d'Aquascaping (nouvel onglet)">
                                Voir les concours
                                </a>
                            </div>
                            </li>
                        </ul>
                        </div>

                    {# Derniers articles publi√©s #}
                    {% if lastArticles is defined and lastArticles|length > 0 %}
                    <div class="mb-4 p-3 bg-white rounded shadow-sm sidebar-card">
                        <h5 class="mb-3"> Derniers articles publi√©s</h5>

                        <ul class="mini-posts list-unstyled m-0">
                    {% for last in lastArticles %}

                    {% set badgeSlug = {
                        'Biotope Am√©rique du sud': 'amerique-sud',
                        'Biotope Am√©rique centrale': 'amerique-centrale',
                        'Biotope asiatique': 'asiatique',
                        'Biotope africain': 'africain',
                        'Biotope australien': 'australien',
                        'Biotope europ√©en': 'europeen',
                        'Biotope eaux saum√¢tres': 'eaux-saumatres',
                        'Biotope mangroves': 'mangroves',
                        'Autre': 'autre'
                    }[last.categorie] ?? 'autre' %}

                    {% set badgeClass = 'badge-' ~ badgeSlug %}

                    {% set icon = {
                        'Biotope Am√©rique du sud': 'üåø',
                        'Biotope Am√©rique centrale': 'üå¥',
                        'Biotope asiatique': 'üéã',
                        'Biotope africain': 'üåæ',
                        'Biotope australien': 'üå∫',
                        'Biotope europ√©en': 'üçÉ',
                        'Biotope eaux saum√¢tres': 'ü´ß',
                        'Biotope mangroves': 'üå±',
                        'Autre': 'üåç'
                    }[last.categorie] ?? 'üåç' %}

                    {% set catFolder = badgeSlug %}
                    {% set randomImage = random([1,2,3]) %}


                            <li class="mini-post">
                            <a href="{{ path('app_article_show', {'id': last.id}) }}" class="mini-link">
                                <div class="thumb-wrap">
                                {% if last.image %}
                                    <img src="{{ asset('uploads/articles/' ~ last.image) }}"
                                        alt="{{ last.titre }}" loading="lazy">
                                {% else %}
                                    <img src="{{ asset('build/images/defaults/articles/' ~ catFolder ~ '/' ~ randomImage ~ '.jpg') }}"
                                        alt="Image par d√©faut - {{ last.categorie }}" loading="lazy">
                                {% endif %}
                                </div>

                                <div class="meta">
                                <h6 class="title">
                                    {{ last.titre|length > 80 ? last.titre|slice(0, 80) ~ '‚Ä¶' : last.titre }}
                                </h6>

                                <div class="row-aux">
                                    <span class="badge {{ badgeClass }}">{{ icon }} {{ last.categorie }}</span>
                                    <small class="date text-muted">{{ last.createdAt|human_date }}</small>
                                </div>
                                </div>
                            </a>
                            </li>
                        {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modale Bootstrap de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-sm border-0 rounded-3">
      <div class="modal-header bg-light border-0">
        <h5 class="modal-title text-dark" id="deleteModalLabel">
          <i class="bi bi-exclamation-circle-fill text-warning me-2 fs-4"></i>
          Attention !
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body text-center">
        <p class="mb-0">
          √ätes-vous s√ªr de vouloir supprimer cet article ?<br>
          <small class="text-muted">Cette action sera irr√©versible.</small>
        </p>
      </div>
      <div class="modal-footer border-0 d-flex justify-content-center gap-3">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
          Annuler
        </button>
        <form id="deleteForm" method="post" class="d-inline">
        <input type="hidden" name="_token" id="deleteFormToken">
        <button type="submit" class="btn btn-confirm-suppression btn-sm px-4 rounded-pill">
        <i class="bi bi-trash3 me-1"></i> Oui, supprimer
        </button>

        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        // Lors de l‚Äôouverture de la modale
        const deleteModal = document.getElementById('deleteModal');
        if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const action = button.getAttribute('data-action');
            const token = button.getAttribute('data-token');

            const form = deleteModal.querySelector('#deleteForm');
            const tokenInput = deleteModal.querySelector('#deleteFormToken');

            form.setAttribute('action', action);
            tokenInput.value = token;

            // classe sp√©ciale au backdrop pour appliquer le flou
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.classList.add('blur-backdrop');
                }
            }, 10);
        });
        }
    </script>
{% endblock %}







