{% extends 'base.html.twig' %}

{% block title %}{{ article.titre }}{% endblock %}

{% block body %}
<div class="article-show-page">

{# --- CONTEXTE RETOUR (article d'origine) --- #}
{% set returnUrl = app.request.query.get('return') %}
{% set returnTitle = app.request.query.get('return_title') %}

{# Valeurs stables √† propager partout #}
{% set originUrl = returnUrl ?: app.request.uri %}
{% set originTitle = returnTitle ?: article.titre %}

  {# --- HERO + badge cat√©gorie --- #}

  {% if article.imageHeader %}
    {% set badgeSlug = {
      'Biotope Am√©rique du sud': 'amerique-sud',
      'Biotope Am√©rique centrale': 'amerique-centrale',
      'Biotope asiatique': 'asiatique',
      'Biotope africain': 'africain',
      'Biotope australien': 'australien',
      'Biotope europ√©en': 'europeen',
      'Biotope eaux saum√¢tres': 'eaux-saumatres',
      'Biotope mangroves': 'mangroves',
      'Autre': 'autre'
    }[article.categorie] ?? 'autre' %}

    {% set badgeClass = 'badge-' ~ badgeSlug %}

    {% set badgeIcon = {
      'Biotope Am√©rique du sud': 'üåø',
      'Biotope Am√©rique centrale': 'üå¥',
      'Biotope asiatique': 'üéã',
      'Biotope africain': 'üåæ',
      'Biotope australien': 'üå∫',
      'Biotope europ√©en': 'üçÉ',
      'Biotope eaux saum√¢tres': 'ü´ß',
      'Biotope mangroves': 'üå±',
      'Autre': 'üåç'
    }[article.categorie] ?? 'üåç' %}

    <section class="hero-header hero-zoom mb-4 card-accent-badge-{{ badgeSlug }}"
              data-bg="{{ asset('uploads/articles/' ~ article.imageHeader) }}">
      <div class="hero-overlay d-flex justify-content-center align-items-center text-center">
        <div>
          <h1 class="hero-title">{{ article.titre }}</h1>
          <span class="badge {{ badgeClass }}">
            {{ badgeIcon }} {{ article.categorie }}
          </span>
          {% if returnUrl %}
            <div class="mt-3">
              <a href="{{ returnUrl }}" class="btn-article-origin" title="{{ originTitle }}">
                ‚Üê Retour √† ¬´ {{ originTitle|slice(0,45) }}{{ originTitle|length > 45 ? '‚Ä¶' : '' }} ¬ª
              </a>
            </div>
          {% endif %}

          {% if currentBiotope is defined and currentBiotope %}
      <div class="mb-3 text-center bio-context bio-{{ currentBiotope }}">
        <div class="d-inline-flex justify-content-center align-items-center gap-2 flex-wrap mt-3">

          {% if prevUrl %}
            <a class="btn-bio-reset"
              href="{{ prevUrl ~ (returnUrl ? ((prevUrl matches '/\\?/' ? '&' : '?')
                  ~ 'return=' ~ returnUrl|url_encode
                  ~ '&return_title=' ~ originTitle|url_encode
              ) : '') }}">
              ‚Üê Pr√©c√©dent
            </a>
          {% endif %}

          <a class="btn-bio-reset"
            href="{{ backUrl ~ (returnUrl ? ((backUrl matches '/\\?/' ? '&' : '?')
                ~ 'return=' ~ returnUrl|url_encode
                ~ '&return_title=' ~ originTitle|url_encode
            ) : '') }}">
            ‚Ü∫ Retour au biotope
          </a>

          {% if nextUrl %}
            <a class="btn-bio-reset"
              href="{{ nextUrl ~ (returnUrl ? ((nextUrl matches '/\\?/' ? '&' : '?')
                  ~ 'return=' ~ returnUrl|url_encode
                  ~ '&return_title=' ~ originTitle|url_encode
              ) : '') }}">
              Suivant ‚Üí
            </a>
          {% endif %}

    </div>
  </div>
{% endif %}

        </div>
      </div>
    </section>

    {% if article.legendeImageHeader %}
      <div class="image-caption text-center mt-2">
        <p class="text-muted small fst-italic">{{ article.legendeImageHeader }}</p>
      </div>
    {% endif %}
  {% endif %}

  <div class="container py-5" id="article-top">

    {# --- CHAPEAU --- #}

    {% if article.chapeau %}
      <p class="article-chapeau lead text-muted mx-auto">{{ article.chapeau }}</p>
    {% endif %}

    <div class="article-card mb-5">
      <div class="article-content">

        {# --- TEXTE + INSERTIONS D'IMAGES (apr√®s P1 et P2) + PULL-QUOTE CONFIGURABLE P3--- #}
    <div class="full-text prose mt-2">

    {# 1) Normalisation #}

    {% set html = article.contenu %}
    {% set hasP = ('</p>' in html) or ('</P>' in html) %}
    {% set withBr = hasP ? html : html|nl2br %}
    {% set norm = withBr|replace({
      '</P>':'</p>', '<BR />':'<br>', '<BR/>':'<br>', '<BR>':'<br>',
      '<br />':'<br>', '<br/>':'<br>'
    }) %}
    {% set parts = hasP ? norm|split('</p>') : norm|split('<br>') %}
    {% set delim = hasP ? '</p>' : '<br>' %}

    {# 2) Index images #}

    {% set leftIndex  = 1 %}
    {% set rightIndex = 2 %}

    {# 3) Pull-quote configurable #}

    {% set pqText  = article.pullQuoteTexte %}
    {% set pqSrc   = article.pullQuoteSource %}
    {% set pqPos   = article.pullQuotePosition ?? 'right' %}
    {% set pqTheme = article.pullQuoteTheme ?? 'default' %}
    {% set pqIndex = article.pullQuoteIndex ?? 2 %}

    {# Classes pull-quote #}

    {% set pqClasses = 'pull-quote ' ~ pqPos ~ (pqTheme != 'default' ? ' pull-quote--' ~ pqTheme : '') %}

    {# Anti-collision : si une image gauche (apr√®s P1) existe et qu'on place un PQ √† droite plus bas #}

    {% if pqPos == 'right' and article.imageGauche and pqIndex > leftIndex %}
      {% set pqClasses = pqClasses ~ ' clear-left' %}
    {% endif %}

    {# 4) Boucle d'affichage + insertions #}

    {% for i, chunk in parts %}
      {% if chunk is not empty %}
        {{ (chunk ~ delim)|raw }}
      {% endif %}

      {# ‚Äî Pull-quote au bon index ‚Äî #}

      {% if pqText and (i + 1) == pqIndex %}
        <figure class="{{ pqClasses }}">
          <blockquote><p>{{ pqText|e|nl2br }}</p></blockquote>
          {% if pqSrc %}<figcaption class="source">{{ pqSrc }}</figcaption>{% endif %}
        </figure>
      {% endif %}

      {# ‚Äî Image gauche apr√®s P1 ‚Äî #}

      {% if article.imageGauche and (i + 1) == leftIndex %}
        <figure class="inline-figure left mb-3">
          <img src="{{ asset('uploads/articles/' ~ article.imageGauche) }}"
              alt="Illustration - {{ article.titre }}" loading="lazy" decoding="async"
              class="img-fluid rounded shadow-sm">
          {% if article.legendeImageGauche %}
            <figcaption class="text-muted small mt-2">{{ article.legendeImageGauche }}</figcaption>
          {% endif %}
        </figure>
      {% endif %}

      {# ‚Äî Image droite apr√®s P2 ‚Äî #}
      
      {% if article.imageDroite and (i + 1) == rightIndex %}
        {% set rightClasses = 'inline-figure right mb-3' ~ (article.imageGauche ? ' clear-left' : '') %}
        <figure class="{{ rightClasses }}">
          <img src="{{ asset('uploads/articles/' ~ article.imageDroite) }}"
              alt="Illustration - {{ article.titre }}" loading="lazy" decoding="async"
              class="img-fluid rounded shadow-sm">
          {% if article.legendeImageDroite %}
            <figcaption class="text-muted small mt-2">{{ article.legendeImageDroite }}</figcaption>
          {% endif %}
        </figure>
      {% endif %}
    {% endfor %}
  </div>

        {# --- Espace pub --- #}

        <div class="advertisement-placeholder my-5 p-4 text-center bg-light border rounded">
          <p class="text-muted fst-italic">[Espace publicitaire r√©serv√©]</p>
        </div>

        {# --- Likes + compteur commentaires --- #}

        <div class="d-flex align-items-center gap-4 mt-4 mb-3">
          <div class="position-relative">
            <button class="like-button border-0 bg-transparent"
                    data-article-id="{{ article.id }}"
                    data-url="{{ path('app_like_toggle', {'id': article.id}) }}">
              <i class="bi bi-heart me-1"></i>
              <span class="like-count">{{ article.likes|length }}</span>
            </button>
            <div class="merci-message">Merci!</div>
          </div>
          <div class="text-muted">
            <i class="bi bi-chat-left-text me-1"></i>{{ commentaires|length }} commentaire{{ commentaires|length > 1 ? 's' }}
          </div>
        </div>

        {# --- Signature auteur --- #}

        <div class="article-footer d-flex justify-content-between align-items-center text-muted flex-wrap">
          <div class="d-flex align-items-center gap-3 flex-wrap">
            {% if article.user %}
              <span>R√©dig√© par</span>
              <a href="{{ path('app_public_profile', {'pseudo': article.user.pseudo}) }}" class="d-flex align-items-center text-decoration-none">
                {% set roleClass = 'user' %}
                {% if 'ROLE_ADMIN' in article.user.roles %}{% set roleClass = 'admin' %}{% endif %}
                {% if article.user.avatar %}
                  <img src="{{ asset('images/avatars/' ~ article.user.avatar) }}" alt="Avatar de {{ article.user.pseudo }}" class="avatar-signature {{ roleClass }}">
                {% else %}
                  <img src="{{ asset('images/avatars/default-avatar.png') }}" alt="Avatar par d√©faut" class="avatar-signature user">
                {% endif %}
                <strong>{{ article.user.pseudo }}</strong>
              </a>
              {% if article.user.articles|length >= 10 %}
                <span class="badge badge-valide ms-2" title="Auteur r√©gulier">Auteur r√©gulier</span>
              {% elseif article.user.articles|length >= 1 %}
                <span class="badge badge-valide ms-2" title="Auteur occasionnel">Auteur occasionnel</span>
              {% endif %}
            {% else %}
              <span class="me-2">R√©dig√© par un auteur disparu</span>
            {% endif %}
          </div>
        </div>

        {# --- Partage --- #}

        {% set shareUrl = app.request.uri %}
        {% set shareTitle = article.titre %}
        <div class="share-bar mt-4">
          <span class="me-2 text-muted">Partager :</span>
          <a class="share-btn" href="https://twitter.com/intent/tweet?url={{ shareUrl|url_encode }}&text={{ shareTitle|url_encode }}" target="_blank" rel="noopener" aria-label="Partager sur X/Twitter"><i class="bi bi-twitter-x"></i></a>
          <a class="share-btn" href="https://www.facebook.com/sharer/sharer.php?u={{ shareUrl|url_encode }}" target="_blank" rel="noopener" aria-label="Partager sur Facebook"><i class="bi bi-facebook"></i></a>
          <a class="share-btn" href="https://www.linkedin.com/sharing/share-offsite/?url={{ shareUrl|url_encode }}" target="_blank" rel="noopener" aria-label="Partager sur LinkedIn"><i class="bi bi-linkedin"></i></a>
          <button class="share-btn copy-url" type="button" aria-label="Copier le lien"><i class="bi bi-link-45deg"></i></button>
        </div>

        {# --- Navigation pr√©c√©dent / suivant --- #}

        {% set slugByCategorie = {
          'Biotope Am√©rique du sud': 'amerique-sud',
          'Biotope Am√©rique centrale': 'amerique-centrale',
          'Biotope asiatique': 'asiatique',
          'Biotope africain': 'africain',
          'Biotope australien': 'australien',
          'Biotope europ√©en': 'europeen',
          'Biotope eaux saum√¢tres': 'eaux-saumatres',
          'Biotope mangroves': 'mangroves',
          'Autre': 'autre'
        } %}

        {% set prevSlug = prev ? (slugByCategorie[prev.categorie] ?? 'autre') : null %}
        {% set nextSlug = next ? (slugByCategorie[next.categorie] ?? 'autre') : null %}

        <nav class="article-nav">
        {% if next %}
          <a href="{{ path('app_article_show', {
              id: next.id,
              return: originUrl,
              return_title: originTitle
          }) }}"
            class="article-nav-card prev biotope-nav biotope-{{ nextSlug }}">
            <span class="nav-label">‚Üê Article pr√©c√©dent</span>
            <strong class="nav-title">{{ next.titre }}</strong>
          </a>
        {% endif %}

        {% if prev %}
          <a href="{{ path('app_article_show', {
              id: prev.id,
              return: originUrl,
              return_title: originTitle
          }) }}"
            class="article-nav-card next biotope-nav biotope-{{ prevSlug }}">
            <span class="nav-label">Article suivant ‚Üí</span>
            <strong class="nav-title">{{ prev.titre }}</strong>
          </a>
        {% endif %}
      </nav>


        {# --- Apr√®s lecture : recommandations + modules --- #}
<section class="after-read mt-5">
  <div class="after-read-inner">

    {# √Ä lire aussi #}
    {% if related is not empty %}
      <div class="after-module">
        <h3 class="after-title">√Ä lire aussi</h3>

        <div class="related-grid">
          {% for r in related %}
            <a href="{{ path('app_article_show', {
                id: r.id,
                return: originUrl,
                return_title: originTitle
            }) }}" class="related-card">
              {% if r.image %}
                <img src="{{ asset('uploads/articles/' ~ r.image) }}" alt="{{ r.titre }}">
              {% else %}
                <div class="no-img"></div>
              {% endif %}
              <div class="rc-body">
                <h4 class="rc-title">{{ r.titre|length > 70 ? r.titre|slice(0,70) ~ '‚Ä¶' : r.titre }}</h4>
                <small class="text-muted">{{ r.createdAt|human_date }}</small>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {# Derniers articles  #}
    {% if lastArticles is defined and lastArticles|length > 0 %}
      <div class="after-module">
        <h3 class="after-title">Derniers articles</h3>

        <ul class="mini-posts list-unstyled m-0">
          {% for last in lastArticles %}
            <li class="mini-post">
              <a href="{{ path('app_article_show', {
                  id: last.id,
                  return: originUrl,
                  return_title: originTitle
              }) }}" class="mini-link">

                <div class="thumb-wrap">
                  {% if last.image %}
                    <img src="{{ asset('uploads/articles/' ~ last.image) }}" alt="{{ last.titre }}" loading="lazy">
                  {% else %}
                    {% set randomImage = random([1,2,3]) %}
                    {% set badgeSlug = {
                      'Biotope Am√©rique du sud': 'amerique-sud',
                      'Biotope Am√©rique centrale': 'amerique-centrale',
                      'Biotope asiatique': 'asiatique',
                      'Biotope africain': 'africain',
                      'Biotope australien': 'australien',
                      'Biotope europ√©en': 'europeen',
                      'Biotope eaux saum√¢tres': 'eaux-saumatres',
                      'Biotope mangroves': 'mangroves',
                      'Autre': 'autre'
                    }[last.categorie] ?? 'autre' %}
                    <img src="{{ asset('build/images/defaults/articles/' ~ badgeSlug ~ '/' ~ randomImage ~ '.jpg') }}"
                        alt="Image par d√©faut - {{ last.categorie }}" loading="lazy">
                  {% endif %}
                </div>

                <div class="meta">
                  <h6 class="title">{{ last.titre|length > 80 ? last.titre|slice(0, 80) ~ '‚Ä¶' : last.titre }}</h6>
                  <small class="date text-muted">{{ last.createdAt|human_date }}</small>
                </div>
              </a>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {#  Explorer ce biotope apr√®s lecture #}

    {# slug biotope (pour URL /articles/biotope/{slug}) #}
    {% set biotopeSlug = {
      'Biotope Am√©rique du sud': 'amerique-sud',
      'Biotope Am√©rique centrale': 'amerique-centrale',
      'Biotope asiatique': 'asiatique',
      'Biotope africain': 'africain',
      'Biotope australien': 'australien',
      'Biotope europ√©en': 'europeen',
      'Biotope eaux saum√¢tres': 'eaux-saumatres',
      'Biotope mangroves': 'mangroves',
      'Autre': 'autre'
    }[article.categorie] ?? 'autre' %}

    {# label ‚Äúhumain‚Äù (pour affichage) #}
    {% set bioLabel = {
      'Biotope Am√©rique du sud': 'biotope d\'Am√©rique du sud',
      'Biotope Am√©rique centrale': 'biotope d\'Am√©rique centrale',
      'Biotope asiatique': 'biotope asiatique',
      'Biotope africain': 'biotope africain',
      'Biotope australien': 'biotope australien',
      'Biotope europ√©en': 'biotope europ√©en',
      'Biotope eaux saum√¢tres': 'biotope eaux saum√¢tres',
      'Biotope mangroves': 'biotope mangroves',
      'Autre': 'biotope'
    }[article.categorie] ?? 'biotope' %}

    <div class="after-module explore-biotope">
      <h3 class="after-title">
        {{ badgeIcon }} Explorer le {{ bioLabel }}
      </h3>

      <p class="text-muted mb-3">
        Articles, esp√®ces et plantes associ√©s au <strong>{{ bioLabel }}</strong>.
      </p>

      <div class="biotope-links">
        {# Articles du biotope (route Symfony) #}
        <a href="{{ path('app_articles_biotope', {
          biotope: biotopeSlug,
          return: originUrl,
          return_title: originTitle
        }) }}" class="biotope-link">
          üìñ Articles
        </a>

        {# Esp√®ces du biotope (query string) #}
        <a href="{{ path('espece_public_index')
            ~ '?biotope=' ~ biotopeSlug
            ~ '&return=' ~ originUrl|url_encode
            ~ '&return_title=' ~ originTitle|url_encode
          }}" class="biotope-link">
          üêü Esp√®ces
        </a>

        {# Plantes du biotope (query string) #}
        <a href="{{ path('plante_public_index')
            ~ '?biotope=' ~ biotopeSlug
            ~ '&return=' ~ originUrl|url_encode
            ~ '&return_title=' ~ originTitle|url_encode
          }}" class="biotope-link">
          üåø Plantes
        </a>
      </div>

    </div>

</section>

        {# <div class="text-end mt-4">
          <a href="#article-top" class="btn btn-outline-secondary btn-sm">‚Üë Retour en haut</a>
        </div> #}

      </div>
    </div>

    <hr>

    {# --- Commentaires --- #}

    <div class="comments-section mt-5">
      <h3>üí¨ Commentaires</h3>
      {% if commentaires is defined and commentaires is not empty %}
        <div class="list-group mt-4">
          {% for commentaire in commentaires %}
            <div class="list-group-item">
              <p class="mb-1">
                <strong>
                  {% if commentaire.auteur %}
                    {{ commentaire.auteur.email }}
                  {% else %}
                    Visiteur
                  {% endif %}
                </strong>
                <span class="text-muted small">le {{ commentaire.dateCommentaire|date('d/m/Y H:i') }}</span>
              </p>
              <p class="mb-0">{{ commentaire.contenu }}</p>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted mt-3">Aucun commentaire pour cet article pour le moment.</p>
      {% endif %}
    </div>

    <hr class="my-5">

    {# --- Formulaire commentaire --- #}
    
    <div class="card p-4 mt-4 shadow-sm">
      <h4>üìù Laisser un commentaire</h4>
      {{ form_start(commentaireForm) }}
      <div class="mb-3">
        {{ form_label(commentaireForm.contenu) }}
        {{ form_widget(commentaireForm.contenu, {'attr': {'class': 'form-control'}}) }}
        {{ form_errors(commentaireForm.contenu) }}
      </div>

      {% if is_granted('IS_AUTHENTICATED_FULLY') %}
        <div class="mb-3">
          {{ form_label(commentaireForm.dateCommentaire) }}
          {{ form_widget(commentaireForm.dateCommentaire, {'attr': {'class': 'form-control'}}) }}
          {{ form_errors(commentaireForm.dateCommentaire) }}
        </div>
        <div class="form-check mb-3">
          {{ form_widget(commentaireForm.approuve, {'attr': {'class': 'form-check-input'}}) }}
          {{ form_label(commentaireForm.approuve, null, {'label_attr': {'class': 'form-check-label'}}) }}
          {{ form_errors(commentaireForm.approuve) }}
        </div>
        <div class="mb-3">
          {{ form_label(commentaireForm.auteur) }}
          {{ form_widget(commentaireForm.auteur, {'attr': {'class': 'form-select'}}) }}
          {{ form_errors(commentaireForm.auteur) }}
        </div>
        <div class="mb-3">
          {{ form_label(commentaireForm.article) }}
          {{ form_widget(commentaireForm.article, {'attr': {'class': 'form-select'}}) }}
          {{ form_errors(commentaireForm.article) }}
        </div>
      {% endif %}

      <button type="submit" class="btn btn-publier">Publier</button>
      {{ form_end(commentaireForm) }}
    </div>

    <div class="text-center mt-4">
      <a href="{{ path('app_articles') }}" class="btn btn-retour-articles">‚Üê Retour aux articles</a>
    </div>

    {% if is_granted('IS_AUTHENTICATED_FULLY') %}
      <div class="text-center mt-2">
        <a href="{{ path('app_profile') }}" class="btn btn-outline-primary">üë§ Retour √† mon profil</a>
      </div>
    {% endif %}

  </div> 
</div> 
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script>
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.copy-url');
      if (!btn) return;
      navigator.clipboard?.writeText(window.location.href).then(() => {
        btn.classList.add('copied');
        setTimeout(() => btn.classList.remove('copied'), 1200);
      });
    });
  </script>
{% endblock %}


















